name: Create Application Version With Sonar Evidence


on:
  workflow_dispatch:

jobs:
  create-app-ver-with-sonar-evidence:
    name: Create Application Version With Sonar Evidence
    runs-on: ubuntu-latest
    env:
      JF_URL: ${{ vars.JF_URL }}
      APP_ID: quotopia-app
      JF_ACCESS_TOKEN: ${{ secrets.JF_ACCESS_TOKEN }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get latest application version
        id: get_app_ver
        run: |
          # Define a temporary file to store the API response body
          RESPONSE_BODY_FILE=$(mktemp)

          # Use the API to get the latest version.
          # We use limit=1 and order_by=created to get the most recent version.
          API_URL="$JF_URL/apptrust/api/v1/applications/$APP_ID/versions?order_by=created&limit=1"

          echo "Fetching latest application version from: $API_URL"

          # Use curl to get the HTTP status code and save the body to a temp file.
          HTTP_CODE=$(curl -sS -o "$RESPONSE_BODY_FILE" -w "%{http_code}" \
            -H "Authorization: Bearer $JF_ACCESS_TOKEN" \
            "$API_URL")

          echo "HTTP Response Code: $HTTP_CODE"

          # Check if the API call was successful (200, 201, 202)
          if [[ "$HTTP_CODE" =~ ^(200|201|202)$ ]]; then
            # Read the JSON response from the temp file.
            RESPONSE_BODY=$(cat "$RESPONSE_BODY_FILE")

            # Use jq to parse the JSON and extract the version.
            LATEST_VER=$(echo "$RESPONSE_BODY" | jq -r '.versions[0].version')

            # Check if the extracted version is null or empty.
            if [ "$LATEST_VER" == "null" ] || [ -z "$LATEST_VER" ]; then
              echo "API call was successful, but no version found. Setting version to 0."
              LATEST_VER="0"
            else
              echo "Found latest application version: $LATEST_VER"
            fi
          else
            echo "Error: API call failed with HTTP status code $HTTP_CODE."
            echo "Response body from temp file:"
            cat "$RESPONSE_BODY_FILE"
            rm "$RESPONSE_BODY_FILE" # Clean up temp file on failure
            exit 1
          fi

          # Clean up the temporary file
          rm "$RESPONSE_BODY_FILE"

          echo "app_ver=$LATEST_VER" >> $GITHUB_OUTPUT

      - name: Create Application Version With Sonar Evidence
        run: |
          echo "APP_ID=$APP_ID"
          LATEST_VER="${{ steps.get_app_ver.outputs.app_ver }}"
          NEXT_VER=$((LATEST_VER + 1))
          echo "LATEST_VER=$LATEST_VER"
          echo "NEXT_VER=$NEXT_VER"

          REQUEST_BODY="{\"version\": \"$NEXT_VER\", \"sources\": {\"builds\": [\
          {\"name\":\"quoteofday\", \"number\":\"25\", \"include_dependencies\":false},\
          {\"name\":\"quotopia-ui\", \"number\":\"6\", \"include_dependencies\":false},\
          {\"name\":\"ai-translate\", \"number\":\"1\", \"include_dependencies\":false}\
          ]}}"
          echo "REQUEST_BODY=$REQUEST_BODY"

          curl -X POST -H "Authorization: Bearer ${{ secrets.JF_ACCESS_TOKEN }}" -d @create_app_no_sonar_evid.jfrog_req "$JF_URL/apptrust/api/v1/applications/quotopia-app/versions?async=false"


